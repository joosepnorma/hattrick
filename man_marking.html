<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hattrick Man Marking Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 p-4 sm:p-6 lg:p-8">
    <div class="max-w-6xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">Man-Marking Calculator</h1>
            <p class="text-gray-400 mt-2">Analyze the effects of a man-marking assignment.</p>
        </header>
        <nav class="bg-gray-800 p-4 mb-8 rounded-lg shadow-lg">
            <div class="max-w-7xl mx-auto flex justify-center space-x-4">
                <a href="index.html" class="text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Match Simulator</a>
                <a href="man_marking.html" class="bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Man-Marking Tool</a>
            </div>
        </nav>

        <main class="space-y-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-4">Step 1: Define the Man-Marking Assignment</h2>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-indigo-400">Your Player (The Marker)</h3>
                        <div>
                            <label for="marker_defending" class="block text-sm font-medium text-gray-300">Defending Skill</label>
                            <input type="number" step="0.1" id="marker_defending" value="15.0" min="1" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="marker_specialty" class="block text-sm font-medium text-gray-300">Specialty</label>
                            <select id="marker_specialty" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                <option value="none">None (Specless)</option>
                                <option value="Powerful">Powerful</option>
                                <option value="Technical">Any other spec</option>
                            </select>
                        </div>
                        <div>
                            <label for="marker_position" class="block text-sm font-medium text-gray-300">Position</label>
                            <select id="marker_position" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                <option>Central Defender</option>
                                <option>Left Wing Back</option>
                                <option>Right Wing Back</option>
                                <option>Inner Midfielder</option>
                            </select>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-xl font-semibold text-indigo-400">Opponent Player (The Marked)</h3>
                        <div>
                            <label for="marked_skill" class="block text-sm font-medium text-gray-300">Highest Skill</label>
                            <input type="number" step="0.1" id="marked_skill" value="15.0" min="1" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label for="marked_specialty" class="block text-sm font-medium text-gray-300">Specialty</label>
                            <select id="marked_specialty" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                <option value="none">None (Specless)</option>
                                <option value="Technical">Technical</option>
                                <option value="Unpredictable">Unpredictable</option>
                                <option value="Powerful">Any other spec</option>
                            </select>
                        </div>
                        <div>
                            <label for="marked_position" class="block text-sm font-medium text-gray-300">Position</label>
                            <select id="marked_position" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                <option>Central Forward</option>
                                <option>Left Winger</option>
                                <option>Right Winger</option>
                                <option>Inner Midfielder</option>
                            </select>
                        </div>
                        <div class="pt-2">
                           <div class="flex items-center gap-2">
                              <input type="checkbox" id="is_on_field" checked class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                              <label for="is_on_field" class="text-sm font-medium text-gray-300">Is on the field?</label>
                           </div>
                       </div>
                    </div>
                </div>
                <div class="text-center mt-6 pt-6 border-t border-gray-700">
                    <button id="calculate_penalty_btn" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Calculate Marking Penalty %</button>
                    <div id="penalty_result" class="mt-3 text-lg font-semibold text-gray-300"></div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-4">Step 2: Enter Initial Team Ratings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold text-indigo-400 mb-4">Your Team (The Marker's Team)</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="marker_team_name" class="block text-sm font-medium text-gray-300">Team Name</label>
                                <input type="text" id="marker_team_name" value="Your Team" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="marker_team_formation" class="block text-sm font-medium text-gray-300">Formation</label>
                                <select id="marker_team_formation" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                    <option>3-5-2</option>
                                    <option>4-4-2</option>
                                    <option>4-5-1</option>
                                    <option>5-3-2</option>
                                    <option>3-4-3</option>
                                    <option>2-5-3</option>
                                    <option>5-5-0</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Defense (R / C / L)</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="number" step="0.1" id="marker_team_r_def" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Right Def">
                                    <input type="number" step="0.1" id="marker_team_c_def" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Cen Def">
                                    <input type="number" step="0.1" id="marker_team_l_def" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Left Def">
                                </div>
                            </div>
                            <div>
                                <label for="marker_team_mid" class="block text-sm font-medium text-gray-300">Midfield</label>
                                <input type="number" step="0.1" id="marker_team_mid" value="10.00" class="mt-1 block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Midfield">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Attack (R / C / L)</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="number" step="0.1" id="marker_team_r_att" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Right Att">
                                    <input type="number" step="0.1" id="marker_team_c_att" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Cen Att">
                                    <input type="number" step="0.1" id="marker_team_l_att" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Left Att">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-semibold text-indigo-400 mb-4">Opponent Team (The Marked's Team)</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="marked_team_name" class="block text-sm font-medium text-gray-300">Team Name</label>
                                <input type="text" id="marked_team_name" value="Opponent Team" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                            </div>
                            <div>
                                <label for="marked_team_formation" class="block text-sm font-medium text-gray-300">Formation</label>
                                <select id="marked_team_formation" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2">
                                     <option>3-5-2</option>
                                     <option>4-4-2</option>
                                     <option>4-5-1</option>
                                     <option>5-3-2</option>
                                     <option>3-4-3</option>
                                     <option>2-5-3</option>
                                     <option>5-5-0</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Defense (R / C / L)</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="number" step="0.1" id="marked_team_r_def" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Right Def">
                                    <input type="number" step="0.1" id="marked_team_c_def" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Cen Def">
                                    <input type="number" step="0.1" id="marked_team_l_def" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Left Def">
                                </div>
                            </div>
                             <div>
                                <label for="marked_team_mid" class="block text-sm font-medium text-gray-300">Midfield</label>
                                <input type="number" step="0.1" id="marked_team_mid" value="10.00" class="mt-1 block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Midfield">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300">Attack (R / C / L)</label>
                                <div class="flex gap-2 mt-1">
                                    <input type="number" step="0.1" id="marked_team_r_att" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Right Att">
                                    <input type="number" step="0.1" id="marked_team_c_att" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Cen Att">
                                    <input type="number" step="0.1" id="marked_team_l_att" value="10.00" class="block w-full bg-gray-700 text-center border-gray-600 rounded-md p-2" placeholder="Left Att">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-xl">
                 <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3 mb-4">Step 3: Define Player Contributions & Calculate</h2>
                 <div class="mb-6">
                    <label for="manual_penalty_input" class="block text-sm font-medium text-gray-300">Man-Marking Effectiveness (%)</label>
                    <input type="number" id="manual_penalty_input" step="0.1" value="50.0" class="mt-1 block w-full md:w-1/3 bg-gray-600 border-gray-500 rounded-md shadow-sm p-2">
                    <p class="text-xs text-gray-400 mt-1">This is auto-filled from Step 1, but you can override it to test hypotheticals.</p>
                 </div>
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="text-xl font-semibold text-indigo-400 mb-4">Your Marker's Contribution</h3>
                        <p class="text-sm text-gray-400 mb-2">Auto-filled based on marker's position and formation. You can edit these values.</p>
                        <div id="marker_contribution_inputs" class="space-y-2"></div>
                    </div>
                     <div>
                        <h3 class="text-xl font-semibold text-indigo-400 mb-4">Opponent's Marked Player Contribution</h3>
                        <p class="text-sm text-gray-400 mb-2">Auto-filled based on marked player's position and formation. You can edit these values.</p>
                        <div id="marked_contribution_inputs" class="space-y-2"></div>
                    </div>
                 </div>
                 <div class="text-center mt-6 pt-6 border-t border-gray-700">
                    <button id="calculate_final_button" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition duration-300 ease-in-out">
                        Calculate Final Team Ratings
                    </button>
                </div>
            </div>

            <div id="results" class="bg-gray-800 p-6 rounded-lg shadow-xl min-h-[100px] hidden">
                <h2 class="text-3xl font-bold text-white mb-4 text-center">Final Post-Marking Ratings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div id="marker_team_results"></div>
                    <div id="marked_team_results"></div>
                </div>
                <div id="export_button_container" class="text-center mt-6 pt-6 border-t border-gray-700 space-y-4">
                    <div class="flex flex-col sm:flex-row justify-center items-center space-y-2 sm:space-y-0 sm:space-x-4">
                        <span class="text-sm font-medium text-gray-300">Export as:</span>
                        <label class="inline-flex items-center">
                            <input type="radio" name="export_roles" value="marker_home" class="form-radio h-4 w-4 text-green-600" checked>
                            <span class="ml-2 text-gray-300">Your Team (Home) vs Opponent (Away)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="export_roles" value="marked_home" class="form-radio h-4 w-4 text-green-600">
                            <span class="ml-2 text-gray-300">Opponent (Home) vs Your Team (Away)</span>
                        </label>
                    </div>
                    <!-- Export button will be injected here after selection -->
                </div>
                <div id="export_status" class="text-center mt-2 text-green-400"></div>
            </div>
        </main>
    </div>

    <script>
        const CONTRIBUTION_DATA = {
            "5-5-0": {
                markerContribution: {
                    "Left Wing Back": { centralDefense: 0.067, leftDefense: 0.340, midfield: 0.016, leftAttack: 0.324 },
                    "Right Wing Back": { centralDefense: 0.067, rightDefense: 0.340, midfield: 0.016, rightAttack: 0.324 },
                    "Central Defender": { centralDefense: 0.168, leftDefense: 0.082, rightDefense: 0.082, midfield: 0.048 },
                    "Inner Midfielder": { centralDefense: 0.050, leftDefense: 0.021, rightDefense: 0.021, midfield: 0.190, centralAttack: 0.083 }
                },
                markedContribution: {
                    "Inner Midfielder": { centralDefense: 0.034, leftDefense: 0.010, rightDefense: 0.010, midfield: 0.203, centralAttack: 0.214, leftAttack: 0.029, rightAttack: 0.029 },
                    "Left Winger": { centralDefense: 0.017, leftDefense: 0.063, midfield: 0.109, centralAttack: 0.071, leftAttack: 0.543 },
                    "Right Winger": { centralDefense: 0.017, rightDefense: 0.063, midfield: 0.109, centralAttack: 0.071, rightAttack: 0.543 }
                }
            },
            "4-5-1": {
                markerContribution: {
                    "Central Defender": { centralDefense: 0.211, rightDefense: 0.100, leftDefense: 0.100},
                    "Left Wing Back": { centralDefense: 0.078, leftDefense: 0.363, midfield: 0.016, leftAttack: 0.250 },
                    "Right Wing Back": { centralDefense: 0.078, rightDefense: 0.363, midfield: 0.016, rightAttack: 0.250 },
                    "Inner Midfielder": { centralDefense: 0.067, leftDefense: 0.025, rightDefense: 0.025, midfield: 0.190, centralAttack: 0.028, leftAttack: 0.019, rightAttack: 0.019 }
                },
                markedContribution: {
                    "Central Forward": { midfield: 0.047, centralAttack: 0.579, leftAttack: 0.231, rightAttack: 0.231 },
                    "Left Winger": { centralDefense: 0.023, leftDefense: 0.076, midfield: 0.109, centralAttack: 0.013, leftAttack: 0.423 },
                    "Right Winger": { centralDefense: 0.023, rightDefense: 0.076, midfield: 0.109, centralAttack: 0.013, rightAttack: 0.423 },
                    "Inner Midfielder": { centralDefense: 0.045, leftDefense: 0.013, rightDefense: 0.013, midfield: 0.203, centralAttack: 0.079, leftAttack: 0.019, rightAttack: 0.019 }
                }
            },
            "3-5-2": {
                markerContribution: {
                    "Central Defender": { centralDefense: 0.268, leftDefense: 0.111, rightDefense: 0.111, midfield: 0.048 },
                    "Left Wing Back": { centralDefense: 0.099, leftDefense: 0.389, midfield: 0.016, leftAttack: 0.203 },
                    "Right Wing Back": { centralDefense: 0.099, rightDefense: 0.389, midfield: 0.016, rightAttack: 0.203 },
                    "Inner Midfielder": { centralDefense: 0.070, leftDefense: 0.028, rightDefense: 0.028, midfield: 0.194, centralAttack: 0.034, leftAttack: 0.016, rightAttack: 0.016 }
                },
                markedContribution: {
                    "Central Forward": { midfield: 0.032, centralAttack: 0.377, leftAttack: 0.200, rightAttack: 0.200 },
                    "Left Winger": { centralDefense: 0.029, leftDefense: 0.084, midfield: 0.111, centralAttack: 0.016, leftAttack: 0.369 },
                    "Right Winger": { centralDefense: 0.029, rightDefense: 0.084, midfield: 0.111, centralAttack: 0.016, rightAttack: 0.369 },
                    "Inner Midfielder": { centralDefense: 0.043, leftDefense: 0.014, rightDefense: 0.014, midfield: 0.206, centralAttack: 0.066, leftAttack: 0.031, rightAttack: 0.031 }
                }
            },
            "2-5-3": {
                markerContribution: {
                    "Central Defender": { centralDefense: 0.286, leftDefense: 0.139, rightDefense: 0.139, midfield: 0.063 },
                    "Left Wing Back": { centralDefense: 0.111, leftDefense: 0.389, midfield: 0.016, leftAttack: 0.189 },
                    "Right Wing Back": { centralDefense: 0.111, rightDefense: 0.389, midfield: 0.016, rightAttack: 0.189 },
                    "Inner Midfielder": { centralDefense: 0.079, leftDefense: 0.026, rightDefense: 0.026, midfield: 0.206, centralAttack: 0.026, leftAttack: 0.014, rightAttack: 0.014 }
                },
                markedContribution: {
                    "Central Forward": { midfield: 0.032, centralAttack: 0.275, leftAttack: 0.172, rightAttack: 0.172 },
                    "Left Winger": { centralDefense: 0.016, leftDefense: 0.084, midfield: 0.095, centralAttack: 0.013, leftAttack: 0.333 },
                    "Right Winger": { centralDefense: 0.016, rightDefense: 0.084, midfield: 0.095, centralAttack: 0.013, rightAttack: 0.333 },
                    "Inner Midfielder": { centralDefense: 0.049, leftDefense: 0.019, rightDefense: 0.019, midfield: 0.206, centralAttack: 0.063, leftAttack: 0.022, rightAttack: 0.022 }
                }
            },
            "3-4-3": {
                markerContribution: {
                    "Central Defender": { centralDefense: 0.275, leftDefense: 0.113, rightDefense: 0.113, midfield: 0.074 },
                    "Left Wing Back": { centralDefense: 0.116, leftDefense: 0.397, midfield: 0.019, leftAttack: 0.176 },
                    "Right Wing Back": { centralDefense: 0.116, rightDefense: 0.397, midfield: 0.019, rightAttack: 0.176 },
                    "Inner Midfielder": { centralDefense: 0.101, leftDefense: 0.028, rightDefense: 0.028, midfield: 0.259, centralAttack: 0.027, leftAttack: 0.021, rightAttack: 0.021 }
                },
                markedContribution: {
                    "Central Forward": { midfield: 0.019, centralAttack: 0.289, leftAttack: 0.151, rightAttack: 0.151 },
                    "Left Winger": { centralDefense: 0.030, leftDefense: 0.086, midfield: 0.111, centralAttack: 0.013, leftAttack: 0.329 },
                    "Right Winger": { centralDefense: 0.030, rightDefense: 0.086, midfield: 0.111, centralAttack: 0.013, rightAttack: 0.329 },
                    "Inner Midfielder": { centralDefense: 0.061, leftDefense: 0.022, rightDefense: 0.022, midfield: 0.259, centralAttack: 0.066, leftAttack: 0.021, rightAttack: 0.021 }
                }
            },
            "4-4-2": {
                markerContribution: {
                    "Central Defender": { centralDefense: 0.207, leftDefense: 0.1025, rightDefense: 0.1025, midfield: 0.055 },
                    "Left Wing Back": { centralDefense: 0.080, leftDefense: 0.372, midfield: 0.018, leftAttack: 0.206 },
                    "Right Wing Back": { centralDefense: 0.080, rightDefense: 0.372, midfield: 0.018, rightAttack: 0.206 },
                    "Inner Midfielder": { centralDefense: 0.069, leftDefense: 0.031, rightDefense: 0.031, midfield: 0.255, centralAttack: 0.036, leftAttack: 0.008, rightAttack: 0.008 }
                },
                markedContribution: {
                    "Central Forward": { midfield: 0.036, centralAttack: 0.397, leftAttack: 0.190, rightAttack: 0.190 },
                    "Left Winger": { centralDefense: 0.024, leftDefense: 0.077, midfield: 0.107, centralAttack: 0.017, leftAttack: 0.365 },
                    "Right Winger": { centralDefense: 0.024, rightDefense: 0.077, midfield: 0.107, centralAttack: 0.017, rightAttack: 0.365 },
                    "Inner Midfielder": { centralDefense: 0.047, leftDefense: 0.019, rightDefense: 0.019, midfield: 0.268, centralAttack: 0.086, leftAttack: 0.024, rightAttack: 0.024 }
                }
            },
            "5-3-2": {
                markerContribution: {
                    "Central Defender": { centralDefense: 0.182, leftDefense: 0.083, rightDefense: 0.083, midfield: 0.068 },
                    "Left Wing Back": { centralDefense: 0.081, leftDefense: 0.345, midfield: 0.023, leftAttack: 0.217 },
                    "Right Wing Back": { centralDefense: 0.081, rightDefense: 0.345, midfield: 0.023, rightAttack: 0.217 },
                    "Inner Midfielder": { centralDefense: 0.071, leftDefense: 0.036, rightDefense: 0.036, midfield: 0.341, centralAttack: 0.041 }
                },
                markedContribution: {
                    "Central Forward": { midfield: 0.044, centralAttack: 0.423, leftAttack: 0.210, rightAttack: 0.210 },
                    "Left Winger": { centralDefense: 0.021, leftDefense: 0.072, midfield: 0.156, leftAttack: 0.387 },
                    "Right Winger": { centralDefense: 0.021, rightDefense: 0.072, midfield: 0.156, rightAttack: 0.387 },
                    "Inner Midfielder": { centralDefense: 0.042, leftDefense: 0.024, rightDefense: 0.024, midfield: 0.356, centralAttack: 0.096, leftAttack: 0.032, rightAttack: 0.032 }
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            
            let lastFinalRatings = null;
            let importedExtraData = { marker: null, marked: null };
            
            const RATING_SECTORS = {
                midfield:       { label: "Midfield",         key: "mid" },
                rightDefense:   { label: "Right Defense",    key: "rDef" },
                centralDefense: { label: "Central Defense",  key: "cDef" },
                leftDefense:    { label: "Left Defense",     key: "lDef" },
                rightAttack:    { label: "Right Attack",     key: "rAtt" },
                centralAttack:  { label: "Central Attack",   key: "cAtt" },
                leftAttack:     { label: "Left Attack",      key: "lAtt" },
            };

            const getInputs = () => {
                const markerContrib = {};
                const markedContrib = {};
                for (const key in RATING_SECTORS) {
                    markerContrib[key] = parseFloat(document.getElementById(`marker_contrib_${key}`)?.value) || 0;
                    markedContrib[key] = parseFloat(document.getElementById(`marked_contrib_${key}`)?.value) || 0;
                }

                return {
                    marker: {
                        name: document.getElementById('marker_team_name').value || "Your Team",
                        defending: parseFloat(document.getElementById('marker_defending').value) || 0,
                        specialty: document.getElementById('marker_specialty').value,
                        position: document.getElementById('marker_position').value,
                        initialRatings: {
                            mid: parseFloat(document.getElementById('marker_team_mid').value) || 0,
                            rDef: parseFloat(document.getElementById('marker_team_r_def').value) || 0,
                            cDef: parseFloat(document.getElementById('marker_team_c_def').value) || 0,
                            lDef: parseFloat(document.getElementById('marker_team_l_def').value) || 0,
                            rAtt: parseFloat(document.getElementById('marker_team_r_att').value) || 0,
                            cAtt: parseFloat(document.getElementById('marker_team_c_att').value) || 0,
                            lAtt: parseFloat(document.getElementById('marker_team_l_att').value) || 0,
                        },
                        contributions: markerContrib,
                    },
                    marked: {
                        name: document.getElementById('marked_team_name').value || "Opponent Team",
                        highestSkill: parseFloat(document.getElementById('marked_skill').value) || 0,
                        specialty: document.getElementById('marked_specialty').value,
                        position: document.getElementById('marked_position').value,
                        isOnField: document.getElementById('is_on_field').checked,
                        initialRatings: {
                            mid: parseFloat(document.getElementById('marked_team_mid').value) || 0,
                            rDef: parseFloat(document.getElementById('marked_team_r_def').value) || 0,
                            cDef: parseFloat(document.getElementById('marked_team_c_def').value) || 0,
                            lDef: parseFloat(document.getElementById('marked_team_l_def').value) || 0,
                            rAtt: parseFloat(document.getElementById('marked_team_r_att').value) || 0,
                            cAtt: parseFloat(document.getElementById('marked_team_c_att').value) || 0,
                            lAtt: parseFloat(document.getElementById('marked_team_l_att').value) || 0,
                        },
                        contributions: markedContrib,
                    }
                };
            };

            const createContributionInputs = (container, prefix) => {
                container.innerHTML = '';
                Object.entries(RATING_SECTORS).forEach(([key, {label}]) => {
                     const div = document.createElement('div');
                    div.className = 'grid grid-cols-3 gap-2 items-center';
                    div.innerHTML = `
                        <label for="${prefix}_${key}" class="text-sm font-medium text-gray-400 col-span-2">to ${label}</label>
                        <div class="flex items-center">
                            <input type="number" step="0.1" id="${prefix}_${key}" value="0.0" class="block w-full bg-gray-600 text-center border-gray-500 rounded-md shadow-sm p-1">
                            <span class="ml-2 text-gray-400">%</span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            };

            const updateContributionGuesstimates = () => {
                // For Marker
                const markerFormation = document.getElementById('marker_team_formation').value;
                const markerPos = document.getElementById('marker_position').value;
                const markerGuesstimates = CONTRIBUTION_DATA[markerFormation]?.markerContribution?.[markerPos] || {};
                for (const key in RATING_SECTORS) {
                    const inputElement = document.getElementById(`marker_contrib_${key}`);
                    if (inputElement) {
                        inputElement.value = ((markerGuesstimates[key] || 0) * 100).toFixed(1);
                    }
                }

                // For Marked
                const markedFormation = document.getElementById('marked_team_formation').value;
                const markedPos = document.getElementById('marked_position').value;
                const markedGuesstimates = CONTRIBUTION_DATA[markedFormation]?.markedContribution?.[markedPos] || {};
                 for (const key in RATING_SECTORS) {
                    const inputElement = document.getElementById(`marked_contrib_${key}`);
                    if(inputElement) {
                        inputElement.value = ((markedGuesstimates[key] || 0) * 100).toFixed(1);
                    }
                }
            };
            
            const areSectorsOpposite = (markerPos, markedPos) => {
                if (markerPos === 'Central Defender' && markedPos === 'Central Forward') return true;
                if ((markerPos === 'Left Wing Back' || markerPos === 'Right Wing Back') && (markedPos === 'Left Winger' || markedPos === 'Right Winger')) return true;
                if (markerPos === 'Inner Midfielder' && markedPos === 'Inner Midfielder') return true;
                return false;
            };

            const calculateMarkerPenalty = (marker, marked) => {
                if (!marked.isOnField) return { penalty: 10, reason: "The opponent player is not on the field." };
                if (areSectorsOpposite(marker.position, marked.position)) return { penalty: 50, reason: "Your player is marking an opponent in an 'opposite' sector." };
                return { penalty: 65, reason: "Your player is marking an opponent in a non-standard sector." };
            };

            const calculateMarkedPenalty = (marker, marked) => {
                if (!marked.isOnField) return { penaltyFactor: 0 };
                let effectiveMarkerDef = marker.defending;
                if (marker.specialty === 'Powerful') effectiveMarkerDef *= 1.10;
                else if (marker.specialty === 'none') effectiveMarkerDef *= 1.05;
                let effectiveMarkedSkill = marked.highestSkill;
                if (marked.specialty === 'Technical') effectiveMarkedSkill *= 0.92;
                else if (marked.specialty === 'Unpredictable') effectiveMarkedSkill *= 1.08;
                const markerTerm = Math.pow(effectiveMarkerDef, 3.5);
                const markedTerm = Math.pow(effectiveMarkedSkill, 3.5);
                return { penaltyFactor: markerTerm / (markerTerm + markedTerm + 1e-9) };
            };

            const renderResultsTable = (title, initialRatings, finalRatings) => {
                 let tableHTML = `<h3 class="text-xl font-semibold text-white mb-2">${title}</h3>`;
                tableHTML += `<table class="w-full text-sm text-left">
                    <thead class="text-xs text-gray-400 uppercase bg-gray-700"><tr>
                        <th class="px-4 py-2">Rating</th><th class="px-4 py-2 text-right">Initial</th><th class="px-4 py-2 text-right">Final</th>
                    </tr></thead><tbody>`;
                for (const { label, key } of Object.values(RATING_SECTORS)) {
                    const initial = initialRatings[key];
                    const final = finalRatings[key];
                    const diff = final - initial;
                    const colorClass = diff < -0.01 ? 'text-red-400' : (diff > 0.01 ? 'text-green-400' : 'text-gray-300');
                    tableHTML += `<tr class="border-b border-gray-700">
                        <th class="px-4 py-2 font-medium whitespace-nowrap text-white">${label}</th>
                        <td class="px-4 py-2 text-right">${initial.toFixed(2)}</td>
                        <td class="px-4 py-2 text-right font-bold ${colorClass}">${final.toFixed(2)}</td>
                    </tr>`;
                }
                tableHTML += '</tbody></table>';
                return tableHTML;
            };

            document.getElementById('calculate_penalty_btn').addEventListener('click', () => {
                const { marker, marked } = getInputs();

                // Calculate penalty on the marked player (effectiveness)
                const markedPenaltyResult = calculateMarkedPenalty(marker, marked);
                document.getElementById('manual_penalty_input').value = (markedPenaltyResult.penaltyFactor * 100).toFixed(1);

                // Calculate penalty on your own player (contribution loss)
                const markerPenaltyResult = calculateMarkerPenalty(marker, marked);

                // Display both results
                document.getElementById('penalty_result').innerHTML = `
                    <div>This assignment is <span class="text-green-400">${(markedPenaltyResult.penaltyFactor * 100).toFixed(1)}%</span> effective.</div>
                    <div class="mt-2 text-sm text-gray-400 font-normal">Your marker loses <span class="text-red-400 font-semibold">${markerPenaltyResult.penalty}%</span> of their contribution. <br><span class="text-xs italic">${markerPenaltyResult.reason}</span></div>
                `;
            });
            
            document.getElementById('calculate_final_button').addEventListener('click', () => {
                const { marker, marked } = getInputs();

                const markerPenaltyResult = calculateMarkerPenalty(marker, marked);
                const selfPenaltyFactor = markerPenaltyResult.penalty / 100.0;
                const finalMarkerRatings = { ...marker.initialRatings };

                for(const key in marker.contributions) {
                    const ratingKey = RATING_SECTORS[key]?.key;
                    if (ratingKey && finalMarkerRatings[ratingKey] !== undefined) {
                        const contribPct = marker.contributions[key] / 100.0;
                        finalMarkerRatings[ratingKey] -= (marker.initialRatings[ratingKey] * contribPct * selfPenaltyFactor);
                    }
                }

                const markedPenaltyFactor = parseFloat(document.getElementById('manual_penalty_input').value) / 100.0 || 0;
                const finalMarkedRatings = { ...marked.initialRatings };
                // Only apply penalty to non-defense sectors
                const defenseKeys = ['rDef', 'cDef', 'lDef'];
                for(const key in marked.contributions) {
                    const ratingKey = RATING_SECTORS[key]?.key;
                    if (
                        ratingKey &&
                        finalMarkedRatings[ratingKey] !== undefined &&
                        !defenseKeys.includes(ratingKey) // skip defense ratings
                    ) {
                        const contribPct = marked.contributions[key] / 100.0;
                        const totalReductionFactor = contribPct * markedPenaltyFactor;
                        finalMarkedRatings[ratingKey] *= (1 - totalReductionFactor);
                    }
                }

                lastFinalRatings = {
                    marker: finalMarkerRatings,
                    marked: finalMarkedRatings
                };

                document.getElementById('marker_team_results').innerHTML = renderResultsTable(`${marker.name}'s Final Ratings`, marker.initialRatings, finalMarkerRatings);
                document.getElementById('marked_team_results').innerHTML = renderResultsTable(`${marked.name}'s Final Ratings`, marked.initialRatings, finalMarkedRatings);
                document.getElementById('results').classList.remove('hidden');

                const exportButtonContainer = document.getElementById('export_button_container');

                // To prevent adding multiple buttons, first remove any existing one.
                const existingButton = document.getElementById('export_to_simulator_btn');
                if (existingButton) {
                    existingButton.remove();
                }

                // Create the button HTML and append it to the container, preserving the radio buttons.
                const buttonHTML = `<button id="export_to_simulator_btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-300 ease-in-out">
                    Export Ratings to Match Simulator
                </button>`;
                exportButtonContainer.insertAdjacentHTML('beforeend', buttonHTML);
                document.getElementById('export_status').innerHTML = '';
            });
            
            document.getElementById('results').addEventListener('click', (e) => {
                if (e.target && e.target.id === 'export_to_simulator_btn') {
                    if (lastFinalRatings) {
                        const keyMap = {
                            mid: 'midfield',
                            rDef: 'r_defense',
                            cDef: 'c_defense',
                            lDef: 'l_defense',
                            rAtt: 'r_attack',
                            cAtt: 'c_attack',
                            lAtt: 'l_attack'
                        };

                        const exportRoleSelection = document.querySelector('input[name="export_roles"]:checked').value;

                        let homeTeamData, awayTeamData;
                        let homeTeamExtraData, awayTeamExtraData;

                        if (exportRoleSelection === 'marker_home') {
                            homeTeamData = lastFinalRatings.marker;
                            awayTeamData = lastFinalRatings.marked;
                            homeTeamExtraData = importedExtraData.marker;
                            awayTeamExtraData = importedExtraData.marked;
                        } else { // marked_home
                            homeTeamData = lastFinalRatings.marked;
                            awayTeamData = lastFinalRatings.marker;
                            homeTeamExtraData = importedExtraData.marked;
                            awayTeamExtraData = importedExtraData.marker;
                        }

                        const ratingsToExport = {
                            home: { ratings: {}, extraData: homeTeamExtraData },
                            away: { ratings: {}, extraData: awayTeamExtraData }
                        };

                        for (const [markerKey, simulatorKey] of Object.entries(keyMap)) {
                            if (homeTeamData[markerKey] !== undefined) ratingsToExport.home.ratings[simulatorKey] = homeTeamData[markerKey];
                            if (awayTeamData[markerKey] !== undefined) ratingsToExport.away.ratings[simulatorKey] = awayTeamData[markerKey];
                        }

                        localStorage.setItem('exportedRatings', JSON.stringify(ratingsToExport));
                        document.getElementById('export_status').innerHTML = `Ratings exported! <a href="index.html" class="underline hover:text-green-300">Go to Match Simulator &raquo;</a>`;
                    }
                }
            });

            const loadImportedRatings = () => {
                const roles = ['marker', 'marked'];
                let importOccurred = false;
                let messages = [];

                const ratingKeyToIdSuffix = {
                    mid: 'mid',
                    rDef: 'r_def',
                    cDef: 'c_def',
                    lDef: 'l_def',
                    rAtt: 'r_att',
                    cAtt: 'c_att',
                    lAtt: 'l_att'
                };

                roles.forEach(role => {
                    const storageKey = `manMarkingImport_${role}`;
                    const importedDataJSON = localStorage.getItem(storageKey);
                    if (!importedDataJSON) {
                        return; // No data for this role, skip
                    }

                    try {
                        const data = JSON.parse(importedDataJSON);
                        const prefix = role === 'marker' ? 'marker_team' : 'marked_team';
                        
                        const nameInput = document.getElementById(`${prefix}_name`);
                        if (nameInput && data.name) {
                            nameInput.value = data.name;
                        }

                        if (data.extraData) {
                            importedExtraData[role] = data.extraData;
                        }

                        for (const [dataKey, idSuffix] of Object.entries(ratingKeyToIdSuffix)) {
                            const inputElement = document.getElementById(`${prefix}_${idSuffix}`);
                            if (inputElement && data.ratings[dataKey] !== undefined) {
                                inputElement.value = data.ratings[dataKey].toFixed(2);
                            }
                        }
                        
                        importOccurred = true;
                        messages.push(`Ratings for <strong>${data.name}</strong> successfully imported as the <strong>${role}</strong>'s team.`);

                    } catch (e) {
                        console.error(`Failed to parse imported ratings for ${role}:`, e);
                    } finally {
                        localStorage.removeItem(storageKey);
                    }
                });

                if (importOccurred) {
                    const statusDiv = document.createElement('div');
                    statusDiv.id = 'import_status';
                    statusDiv.className = 'bg-green-900/50 border border-green-700 text-green-300 px-4 py-3 rounded-lg relative mb-6 text-center space-y-2';
                    statusDiv.innerHTML = messages.join('<br>');
                    const mainElement = document.querySelector('main');
                    mainElement.insertBefore(statusDiv, mainElement.firstChild);
                }
            };

            createContributionInputs(document.getElementById('marker_contribution_inputs'), 'marker_contrib');
            createContributionInputs(document.getElementById('marked_contribution_inputs'), 'marked_contrib');
            
            document.getElementById('marker_team_formation').addEventListener('change', updateContributionGuesstimates);
            document.getElementById('marker_position').addEventListener('change', updateContributionGuesstimates);
            document.getElementById('marked_team_formation').addEventListener('change', updateContributionGuesstimates);
            document.getElementById('marked_position').addEventListener('change', updateContributionGuesstimates);
            
            loadImportedRatings();
            updateContributionGuesstimates();
        });
    </script>
</body>
</html>
